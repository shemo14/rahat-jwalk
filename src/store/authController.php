<?phpnamespace App\Http\Controllers\api;use Illuminate\Http\Request;use App\Http\Controllers\Controller;use App\User;use Auth;use App;use Carbon\Carbon;use App\Mail\activeUser;use Mail;use Validator;use Hash;class AuthController extends Controller{	#Register	public function register(Request $request)	{		/** Set Lang **/		$request->lang == 'en' ? App::setLocale('en') : App::setLocale('ar');		/** Set Carbon Language **/		$request->lang == 'en' ? Carbon::setLocale('en') : Carbon::setLocale('ar');		/** Validate Request **/		$validate = Validator::make($request->all() , [			'lang'           => 'nullable',			'name'           => 'required',			'phone'          => 'required|unique:users',			'city'           => 'required',			'lat'            => 'required',			'lng'            => 'required',			'device_id'      => 'required',			'password'       => 'required|min:6',			'email'          => 'nullable|email',		]);		/** Send Error Massages **/		if($validate->fails()){			$phone 	= User::where('phone',$request->phone)->first();			if (isset($phone)) {				return response()->json([					'key'       => '0'   ,					'massage'   => trans('api.uniquePhone')				]);			}			return response()->json([				'key'       => '0'   ,				'massage'   => $validate->errors()			]);		}		/** Save data to users **/		$user   = new User;		$user->name            = $request->name;		$user->phone           = $request->phone;		$user->password        = bcrypt($request->password);		$user->city            = $request->city;		$user->lat             = $request->lat;		$user->lat             = $request->lat;		$user->email           = $request->email;		$user->device_id       = $request->device_id;		$user->image           = 'default.png';		$user->active          = 1;		// $user->code            = $code;		$user->save();		/** Send Active Code To User's Phone **/		// send_mobile_sms($request->phone , 'Activation Code :  ' . $code);		/** Data Array **/		$data = [];		$data['id']                 = is_null($user->id)        ? '' : $user->id;		$data['name']               = is_null($user->name)      ? '' : $user->name;		$data['phone']              = is_null($user->phone)     ? '' : $user->phone;		$data['active']             = is_null($user->active)    ? '' : $user->active;		$data['city']               = is_null($user->city)      ? '' : $user->city;		$data['lat']                = is_null($user->lat)       ? '' : $user->lat;		$data['lng']                = is_null($user->lng)       ? '' : $user->lng;		$data['code']               = is_null($user->code)      ? '' : $user->code;		$data['image']              = url('dashboard/uploads/users/' . $user->image);		$data['email']              = is_null($user->email)     ? '' : $user->email;		$data['provider']           = is_null($user->provider)  ? 0  : $user->provider; // 0 = user , 1 = provider		$data['device_id']          = is_null($user->device_id) ? '' : $user->device_id;		$data['commission']         = is_null($user->commission)? 0 : (int)$user->commission;		$data['mob_maintenance']    = is_null($user->mob_maintenance)    ? (boolean)'0' : (boolean)$user->mob_maintenance;		$data['mob_seller']         = is_null($user->mob_seller)         ? (boolean)'0' : (boolean)$user->mob_seller;		$data['accessories_seller'] = is_null($user->accessories_seller) ? (boolean)'0' : (boolean)$user->accessories_seller;		$data['sim_card']           = is_null($user->sim_card)           ? (boolean)'0' : (boolean)$user->sim_card;		/** Send Stored User Data **/		return response()->json([			'key'       => '1'   ,			'massage'   => trans('api.saveRegister'),			'data'      => $data		]);	}	public function user_data(Request $request){		$user = User::find($request['id']);		/** Data Array **/		$data = [];		$data['id']                 = is_null($user->id)        ? '' : $user->id;		$data['name']               = is_null($user->name)      ? '' : $user->name;		$data['phone']              = is_null($user->phone)     ? '' : $user->phone;		$data['active']             = is_null($user->active)    ? '' : $user->active;		$data['city']               = is_null($user->city)      ? '' : $user->city;		$data['lat']                = is_null($user->lat)       ? '' : $user->lat;		$data['lng']                = is_null($user->lng)       ? '' : $user->lng;		$data['code']               = is_null($user->code)      ? '' : $user->code;		$data['image']              = url('dashboard/uploads/users/' . $user->image);		$data['email']              = is_null($user->email)     ? '' : $user->email;		$data['provider']           = is_null($user->provider)  ? '' : $user->provider; // 0 = user , 1 = provider		$data['commission']         = is_null($user->commission)? 0 : (int)$user->commission;		$data['device_id']          = is_null($user->device_id) ? '' : $user->device_id;		$data['mob_maintenance']    = is_null($user->mob_maintenance)    ? (boolean)'0' : (boolean)$user->mob_maintenance;		$data['mob_seller']         = is_null($user->mob_seller)         ? (boolean)'0' : (boolean)$user->mob_seller;		$data['accessories_seller'] = is_null($user->accessories_seller) ? (boolean)'0' : (boolean)$user->accessories_seller;		$data['sim_card']           = is_null($user->sim_card)           ? (boolean)'0' : (boolean)$user->sim_card;		return response()->json([			'key'       => '1'   ,//			'massage'   => trans('api.successLogin'),			'data'      => $data		]);	}	#login	public function login(Request $request)	{		/** Set Lang **/		$request->lang == 'en' ? App::setLocale('en') : App::setLocale('ar');		/** Set Carbon Language **/		$request->lang == 'en' ? Carbon::setLocale('en') : Carbon::setLocale('ar');		/** Validate Request **/		$validate = Validator::make($request->all() , [			'lang'          => 'nullable',			'phone'         => 'required',			'password'      => 'required',			'device_id'     => 'required',		]);		/** Send Error Massages **/		if($validate->fails()){			return response()->json([				'key'       => '0'   ,				'massage'   => $validate->errors()			]);		}		/** Login **/		if (Auth::attempt([			'phone'    => $request->phone    ,			'password' => $request->password ,			'active'   => 1		])) {			/** If Login Success **/			$user = User::find(Auth::user()->id);			$user->device_id    = is_null($request->device_id) ? '' : $request->device_id ;			$user->save();			/** Data Array **/			$data = [];			$data['id']                 = is_null($user->id)        ? '' : $user->id;			$data['name']               = is_null($user->name)      ? '' : $user->name;			$data['phone']              = is_null($user->phone)     ? '' : $user->phone;			$data['active']             = is_null($user->active)    ? '' : $user->active;			$data['city']               = is_null($user->city)      ? '' : $user->city;			$data['lat']                = is_null($user->lat)       ? '' : $user->lat;			$data['lng']                = is_null($user->lng)       ? '' : $user->lng;			$data['code']               = is_null($user->code)      ? '' : $user->code;			$data['image']              = url('dashboard/uploads/users/' . $user->image);			$data['email']              = is_null($user->email)     ? '' : $user->email;			$data['provider']           = is_null($user->provider)  ? '' : $user->provider; // 0 = user , 1 = provider			$data['commission']         = is_null($user->commission)? 0 : (int)$user->commission;			$data['device_id']          = is_null($user->device_id) ? '' : $user->device_id;			$data['mob_maintenance']    = is_null($user->mob_maintenance)    ? (boolean)'0' : (boolean)$user->mob_maintenance;			$data['mob_seller']         = is_null($user->mob_seller)         ? (boolean)'0' : (boolean)$user->mob_seller;			$data['accessories_seller'] = is_null($user->accessories_seller) ? (boolean)'0' : (boolean)$user->accessories_seller;			$data['sim_card']           = is_null($user->sim_card)           ? (boolean)'0' : (boolean)$user->sim_card;			return response()->json([				'key'       => '1'   ,				'massage'   => trans('api.successLogin'),				'data'      => $data			]);		}		if (Auth::attempt([			'phone'    => $request->phone ,			'password' => $request->password		])) {			/** If Login Success But Not Active User **/			/** If Login Success **/			$user = User::find(Auth::user()->id);			/** Data Array **/			$data = [];			$data['id']                 = is_null($user->id)        ? '' : $user->id;			$data['name']               = is_null($user->name)      ? '' : $user->name;			$data['phone']              = is_null($user->phone)     ? '' : $user->phone;			$data['active']             = is_null($user->active)    ? '' : $user->active;			$data['city']               = is_null($user->city)      ? '' : $user->city;			$data['lat']                = is_null($user->lat)       ? '' : $user->lat;			$data['lng']                = is_null($user->lng)       ? '' : $user->lng;			$data['code']               = is_null($user->code)      ? '' : $user->code;			$data['image']              = url('dashboard/uploads/users/' . $user->image);			$data['email']              = is_null($user->email)     ? '' : $user->email;			$data['provider']           = is_null($user->provider)  ? '' : $user->provider; // 0 = user , 1 = provider			$data['commission']         = is_null($user->commission)? 0 : (int)$user->commission;			$data['device_id']          = is_null($user->device_id) ? '' : $user->device_id;			$data['mob_maintenance']    = is_null($user->mob_maintenance)    ? (boolean)'0' : (boolean)$user->mob_maintenance;			$data['mob_seller']         = is_null($user->mob_seller)         ? (boolean)'0' : (boolean)$user->mob_seller;			$data['accessories_seller'] = is_null($user->accessories_seller) ? (boolean)'0' : (boolean)$user->accessories_seller;			$data['sim_card']           = is_null($user->sim_card)           ? (boolean)'0' : (boolean)$user->sim_card;			return response()->json([				'key'       => '2'   ,				'massage'   => trans('api.blocked'),				'data'      => $data			]);		}		/** If Login wrong **/		return response()->json([			'key'       => '0'   ,			'massage'   => trans('api.wrongLogin')		]);	}	#logout	public function logout(Request $request)	{		/** Set Lang **/		$request->lang == 'en' ? App::setLocale('en') : App::setLocale('ar') ;		/** Validate Request **/		$validate = Validator::make($request->all() , [			'lang'          => 'nullable',			'user_id'       => 'required',		]);		/** Send Error Massages **/		if($validate->fails()){			return response()->json([				'key'       => '0'   ,				'massage'   => $validate->errors()			]);		}		$user = User::find($request->user_id);		/** Check User **/		if (!isset($user)) {			return response()->json([				'key'       => '0'   ,				'massage'   => trans('api.wrongUser')			]);		}		/** Updat device_id To '' **/		$user->device_id   =  null;		$user->save();		return response()->json([			'key'       => '1'   ,			'massage'   => trans('api.Logout')		]);	}	#Resend Code	public function resend_code(Request $request)	{		/** Set Lang **/		$request->lang == 'en' ? App::setLocale('en') : App::setLocale('ar') ;		/** Validate Request **/		$validate = Validator::make($request->all() , [			'lang'          => 'nullable',			'user_id'       => 'required',		]);		/** Send Error Massages **/		if($validate->fails()){			return response()->json([				'key'       => '0'   ,				'massage'   => $validate->errors()			]);		}		$user = User::find($request->user_id);		/** Check User **/		if (!isset($user)) {			return response()->json([				'key'       => '0'   ,				'massage'   => trans('api.wrongUser')			]);		}		/** Send Active Code To User's Phone **/		// send_mobile_sms($user->phone , 'Activation Code :  ' . $user->code);		$app  = 'Activation Code is :  ' . $user->code;		\Mail::to($user->email)->send(new activeUser($app));		return response()->json([			'key'       => '1'   ,			'massage'   => trans('api.send')		]);	}	public function check_code(Request $request)	{		/** Set Lang **/		$request->lang == 'en' ? App::setLocale('en') : App::setLocale('ar') ;		/** Validate Request **/		$validate = Validator::make($request->all() , [			'lang'      => 'nullable',			'user_id'   => 'required',			'code'      => 'required',		]);		/** Send Error Massages **/		if($validate->fails()){			return response()->json([				'key'       => '0'   ,				'massage'   => $validate->errors()			]);		}		$user = User::find($request->user_id);		/** Check User **/		if (!isset($user)) {			return response()->json([				'key'       => '0'   ,				'massage'   => trans('api.wrongUser')			]);		}		/** Check Code **/		if ($user->code == $request->code) {			/** If Code Success **/			$user->active = 1;			$user->code   = null;			$user->save();			$data = [];			$data['id']                 = is_null($user->id)        ? '' : $user->id;			$data['name']               = is_null($user->name)      ? '' : $user->name;			$data['phone']              = is_null($user->phone)     ? '' : $user->phone;			$data['active']             = is_null($user->active)     ? '' : $user->active;			$data['city']               = is_null($user->city)      ? '' : $user->city;			$data['lat']                = is_null($user->lat)       ? '' : $user->lat;			$data['lng']                = is_null($user->lng)       ? '' : $user->lng;			$data['code']               = is_null($user->code)      ? '' : $user->code;			$data['image']              = url('dashboard/uploads/users/' . $user->image);			$data['email']              = is_null($user->email)     ? '' : $user->email;			$data['provider']           = is_null($user->provider)  ? '' : $user->provider; // 0 = user , 1 = provider			$data['commission']         = is_null($user->commission)? 0 : (int)$user->commission;			$data['device_id']          = is_null($user->device_id) ? '' : $user->device_id;			$data['mob_maintenance']    = is_null($user->mob_maintenance)    ? (boolean)'0' : (boolean)$user->mob_maintenance;			$data['mob_seller']         = is_null($user->mob_seller)         ? (boolean)'0' : (boolean)$user->mob_seller;			$data['accessories_seller'] = is_null($user->accessories_seller) ? (boolean)'0' : (boolean)$user->accessories_seller;			$data['sim_card']           = is_null($user->sim_card)           ? (boolean)'0' : (boolean)$user->sim_card;			return response()->json([				'key'       => '1'   ,				'massage'   => trans('api.successCode'),				'data'      => $data			]);		}		/** If Code wrong **/		return response()->json([			'key'       => '0'   ,			'massage'   => trans('api.wrongCode')		]);	}	#Check Phone	public function check_phone(Request $request)	{		/** Set Lang **/		$request->lang == 'en' ? App::setLocale('en') : App::setLocale('ar');		/** Set Carbon Language **/		$request->lang == 'en' ? Carbon::setLocale('en') : Carbon::setLocale('ar');		/** Validate Request **/		$validate = Validator::make($request->all() , [			'lang'       => 'nullable',			'email'      => 'required',		]);		/** Send Error Massages **/		if($validate->fails()){			return response()->json([				'key'       => '0'   ,				'massage'   => $validate->errors()			]);		}		$user = User::where('email' , $request->email)->first();		/** Check User **/		if (!isset($user)) {			return response()->json([				'key'       => '0'   ,				'massage'   => trans('api.wrongUser')			]);		}		/** Send Code **/		$user->code = rand(11111,99999);		$user->code = 2222;		$user->save();		/** Send Code To User's email **/		//send_mobile_sms($user->email , 'Verification Code is :  ' . $user->code);		$app  = 'Activation Code is :  ' . $user->code;		\Mail::to($user->email)->send(new activeUser($app));		/** Data Array **/		$data = [];		$data['id']                 = is_null($user->id)        ? '' : $user->id;		$data['name']               = is_null($user->name)      ? '' : $user->name;		$data['phone']              = is_null($user->phone)     ? '' : $user->phone;		$data['active']             = is_null($user->active)    ? '' : $user->active;		$data['city']               = is_null($user->city)      ? '' : $user->city;		$data['lat']                = is_null($user->lat)       ? '' : $user->lat;		$data['lng']                = is_null($user->lng)       ? '' : $user->lng;		$data['code']               = is_null($user->code)      ? '' : $user->code;		$data['image']              = url('dashboard/uploads/users/' . $user->image);		$data['email']              = is_null($user->email)     ? '' : $user->email;		$data['provider']           = is_null($user->provider)  ? '' : $user->provider; // 0 = user , 1 = provider		$data['commission']         = is_null($user->commission)? 0 : (int)$user->commission;		$data['device_id']          = is_null($user->device_id) ? '' : $user->device_id;		$data['mob_maintenance']    = is_null($user->mob_maintenance)    ? (boolean)'0' : (boolean)$user->mob_maintenance;		$data['mob_seller']         = is_null($user->mob_seller)         ? (boolean)'0' : (boolean)$user->mob_seller;		$data['accessories_seller'] = is_null($user->accessories_seller) ? (boolean)'0' : (boolean)$user->accessories_seller;		$data['sim_card']           = is_null($user->sim_card)           ? (boolean)'0' : (boolean)$user->sim_card;		/** Send Success Massage **/		return response()->json([			'key'       => '1'   ,			'massage'   => trans('api.sendCode'),			'data'      => $data		]);	}	#Check Code && Update Password	public function check_code_And_Repassword(Request $request)	{		/** Set Lang **/		$request->lang == 'en' ? App::setLocale('en') : App::setLocale('ar');		/** Set Carbon Language **/		$request->lang == 'en' ? Carbon::setLocale('en') : Carbon::setLocale('ar');		/** Validate Request **/		$validate = Validator::make($request->all() , [			'lang'      => 'nullable',			'user_id'   => 'required',			'code'      => 'required',			'password'  => 'required',		]);		/** Send Error Massages **/		if($validate->fails()){			return response()->json([				'key'       => '0'   ,				'massage'   => $validate->errors()			]);		}		$user = User::find($request->user_id);		/** Check User **/		if (!isset($user)) {			return response()->json([				'key'       => '0'   ,				'massage'   => trans('api.wrongUser')			]);		}		/** Check Code **/		if ($user->code == $request->code) {			/** Sent New Password **/			$user->password  = bcrypt($request->password);			$user->save();			/** Data Array **/			$data = [];			$data['id']                 = is_null($user->id)        ? '' : $user->id;			$data['name']               = is_null($user->name)      ? '' : $user->name;			$data['phone']              = is_null($user->phone)     ? '' : $user->phone;			$data['active']             = is_null($user->active)    ? '' : $user->active;			$data['city']               = is_null($user->city)      ? '' : $user->city;			$data['lat']                = is_null($user->lat)       ? '' : $user->lat;			$data['lng']                = is_null($user->lng)       ? '' : $user->lng;			$data['code']               = is_null($user->code)      ? '' : $user->code;			$data['image']              = url('dashboard/uploads/users/' . $user->image);			$data['email']              = is_null($user->email)     ? '' : $user->email;			$data['provider']           = is_null($user->provider)  ? '' : $user->provider; // 0 = user , 1 = provider			$data['commission']         = is_null($user->commission)? 0 : (int)$user->commission;			$data['device_id']          = is_null($user->device_id) ? '' : $user->device_id;			$data['mob_maintenance']    = is_null($user->mob_maintenance)    ? (boolean)'0' : (boolean)$user->mob_maintenance;			$data['mob_seller']         = is_null($user->mob_seller)         ? (boolean)'0' : (boolean)$user->mob_seller;			$data['accessories_seller'] = is_null($user->accessories_seller) ? (boolean)'0' : (boolean)$user->accessories_seller;			$data['sim_card']           = is_null($user->sim_card)           ? (boolean)'0' : (boolean)$user->sim_card;			return response()->json([				'key'       => '1'   ,				'massage'   => trans('api.savePassword'),				'data'      => $data			]);		}		/** If Code wrong **/		return response()->json([			'key'       => '0'   ,			'massage'   => trans('api.wrongCode')		]);	}}